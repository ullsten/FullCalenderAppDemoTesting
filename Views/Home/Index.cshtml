<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='utf-8' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css' />

    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js'></script>

    <!-- Add these lines -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@latest/dist/js/bootstrap-datepicker.min.js" crossorigin="anonymous"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css' />

    <script>

        document.addEventListener('DOMContentLoaded', function () {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {

                timeZone: 'Europe/Stockholm',
                locale: 'sv', // Set the locale to Swedish

                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay',
                },
                buttonText: {
                    prev: 'Föregående',
                    next: 'Nästa',
                    today: 'Idag',
                    month: 'Månad',
                    week: 'Vecka',
                    day: 'Dag',
                },

                //set default color for event (bordercolor ?)
                eventColor: 'green',

                //set color for event from value in database
                eventDidMount: function (info) {
                    // Get the event object
                    var event = info.event;

                    // Set the background color for the event using the themeColor property
                    event.setProp('backgroundColor', event.extendedProps.themeColor);
                },

                editable: true, // Allow events to be dragged and resized
                selectable: true, // Enable date selection

                // Add events/fetch from action/database
                events: {
                    url: 'Home/GetEvents',
                    failure: function () {
                        alert('Failed to retrieve events. Please try again later');
                    }
                },



                // Handle date selection
                select: function (info) {
                    // Get the selected start and end dates
                    var start = moment(info.start).format('YYYY-MM-DDTHH:mm:ss');
                    var end = moment(info.end).format('YYYY-MM-DDTHH:mm:ss');

                    // Set the start and end dates in the event creation form
                    document.getElementById('start').value = start;
                    document.getElementById('end').value = end;

                    // Show the event creation modal
                    $('#CreateEventModal').modal('show');

                    // Show the event creation modal using Bootstrap Modal API
                    //var modal = new bootstrap.Modal(document.getElementById('eventModal'));
                    //modal.show();
                },
      
                eventClick: function (info) {
                    // Get the clicked event
                    var event = info.event;

                    console.log("ID:" + event.extendedProps.eventId);
                    console.log(info.event);

                    // Create a div element to display the event details
                    var eventDetails = document.createElement('div');
                    eventDetails.innerHTML = `
                        <p><strong>Subject:</strong> ${event.title}</p>
                        <p><strong>Description:</strong> ${event.extendedProps.description}</p>
                        <p><strong>Start:</strong> ${moment(event.start).format('YYYY-MM-DD HH:mm')}</p>
                        <p><strong>End:</strong> ${moment(event.end).format('YYYY-MM-DD HH:mm')}</p>
                    `;

                    // Show the event details in the modal
                    var eventModalBody = document.getElementById('eventModalBody');
                    eventModalBody.innerHTML = '';
                    eventModalBody.appendChild(eventDetails);

                    // show clicked event
                    $('#eventModalDetail').modal('show');
                    //$('#editEventModal').modal('hide');

                    // Click event handler for the deleteEvent button
                    $('#editButton').click(function () {
                       
                        event.extendedProps.eventId;

                        $('#editEventModal').modal('show');
                        $('#eventModalDetail').modal('hide');
                    });

                    // Click event handler for the deleteEvent button
                    $('#deleteEvent').click(function () {

                        if (event != null && confirm('Are you sure you want to delete this event?')) {

                            $.ajax({
                                type: 'POST',
                                url: 'Home/DeleteEvent', // Replace with the actual URL to delete the event on the server
                                data: {
                                    eventId: event.extendedProps.eventId // Pass the event ID to delete
                                },
                                success: function (data) {
                                    // Handle success response, if needed
                                    // Reload the events after successful deletion, you can use 'calendar.refetchEvents()' or other appropriate methods.
                                    alert('Event successfully deleted.')
                                },
                                error: function () {
                                    alert('Failed to delete event. Please try again later.');
                                }
                            });
                        }
                    });


                },
 
            });

            calendar.render();
        });

    </script>
</head>
<body>

    @*Display calandar*@
    <div id='calendar'></div>


    <!-- Modal for event details with buttons -->
    <div class="modal fade" id="eventModalDetail" tabindex="-1" role="dialog" aria-labelledby="eventModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventModalLabel">Event Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                        @*<span aria-hidden="true">&times;</span>*@
                    </button>
                </div>
                <div class="modal-body" id="eventModalBody">
                    <!-- Event details will be displayed here -->
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" id="editButton">Edit</button>
                    <button class="btn btn-danger" id="deleteEvent">Delete</button>
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    @***********************Event creation modal*****************************@
    <div class="modal fade" id="CreateEventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventModalLabel">Create Event</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    @*Json action*@
                    @*action="Home/SaveEvent"*@
                    @*asp-action="Create" asp-controller="Events""*@

                    <form id="createEventForm" method="post" action="Home/SaveEvent">
                        <div class="form-group">
                            <input class="form-control" type="text" name="Subject" placeholder="Subject" required />
                        </div>
                        <div class="form-group mt-2">
                            <label for="start">Start</label>
                            <input class="form-control" type="datetime-local" id="start" name="Start" required />
                        </div>

                        <div class="form-group">
                            <label for="start">End</label>
                            <input class="form-control" type="datetime-local" id="end" name="End" />
                        </div>

                        <div class="form-group mt-2">
                            <label for="Description">Description</label>
                            <textarea id="Description" name="Description" class="form-control"></textarea>
                        </div>

                        <div class="form-group mt-2">
                            <label for="ThemeColor">Color</label>
                            <input class="form-control" type="text" name="ThemeColor" placeholder="Color" />
                        </div>

                        <div class="form-group mt-2">
                            <input class="form-check-input" type="checkbox" name="IsFullDay" /> Full day
                        </div>

                        <div class="form-group mt-2">
                            <input class="btn btn-primary" type="submit" value="Create Event" />
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    @**************Edit modal*********************@
    <div class="modal fade" id="editEventModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Edit Event</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">

                    @*method="post" action="Home/UpdateEvent"*@
                    <form id="editEventForm" method="post" action="Home/UpdateEvent">
                        @*<form id="editEventForm" method="post" action-action="Edit" asp-controller="Events">*@
                        <input type="hidden" id="editEventId" name="EventId" />
                        <div class="form-group">
                            <label for="editSubject">Subject</label>
                            <input type="text" id="editSubject" name="Subject" class="form-control" required />
                        </div>
                        <div class="form-group">
                            <label for="editDescription">Description</label>
                            <textarea id="editDescription" name="Description" class="form-control"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="editStart">Start</label>
                            <input type="datetime-local" id="editStart" name="Start" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label for="editEnd">End</label>
                            <input type="datetime-local" id="editEnd" name="End" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label for="editThemeColor">Theme Color</label>
                            <input type="text" id="editThemeColor" name="ThemeColor" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label for="editIsFullDay">Is Full Day</label>
                            <input type="checkbox" id="editIsFullDay" name="IsFullDay" class="form-check-input" />
                        </div>
                        <input type="submit" value="Save Changes" class="btn btn-primary" id="saveChangesBtn" />
                    </form>
                </div>
            </div>
        </div>
    </div>
</body>
</html>


@*
TODO
edit and delete button
drag and drop*@
@*


                    //Refresh not working
                    // Add the event listener for the "Save Changes" button in the edit modal
                    //document.getElementById('saveChangesBtn').addEventListener('click', function (event) {
                    //    event.preventDefault(); // Prevent the form from submitting normally

                    //    // Get the form data from the edit modal
                    //    var formData = new FormData(document.getElementById('editEventForm'));

                    //    // Send an AJAX request to update the event on the server
                    //    $.ajax({
                    //        url: 'Home/UpdateEvent', // Replace this with the correct URL for your server-side action
                    //        method: 'POST',
                    //        data: formData,
                    //        processData: false,
                    //        contentType: false,
                    //        success: function (response) {
                    //            console.log(response);

                    //            if (response.status) {
                    //                // Event updated successfully
                    //                $('#editModal').modal('hide'); // Hide the edit modal
                    //                $('#calendar').fullCalendar('refetchEvents'); // Refresh the calendar events
                    //            } else {
                    //                // Event update failed
                    //                // Display an error message to the user (if needed)
                    //                console.log(response.message);
                    //            }
                    //        },
                    //        error: function (error) {
                    //            // Handle AJAX error (if needed)
                    //            console.log(error);
                    //        }
                    //    });

                    //});

                        *@